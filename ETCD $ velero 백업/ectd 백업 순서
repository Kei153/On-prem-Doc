-- etcd ë°±ì—…ì„ ìœ„í•œ ìŠ¤í¬ë¦½íŠ¸ -- (ë²„ì „ë³„ë¡œ ë‹¤ë¥¼ ìˆ˜ ì‡ë‹¤. ê²½ë¡œë“¤ì´ ì–´ë””ìˆëŠ”ì§€ í™•ì¸ í•´ ë³¼ê²ƒ)

** â—ï¸â—ï¸etcd ì •ë³´ë¥¼ ì–»ì„ ë•ŒëŠ” kubeadmì´ë“ , kubesprayë“ , ë²„ì „ì´ ëª‡ì´ë“  ì œì¼ ë¨¼ì € í•´ì•¼ í•˜ëŠ” ê±´ í˜„ì¬ í´ëŸ¬ìŠ¤í„°ì—ì„œ etcdê°€ ì–´ë–»ê²Œ ì‹¤í–‰ë˜ê³  ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ê²ƒâ—ï¸â—ï¸ **

ğŸ’¡ 1ë‹¨ê³„. etcdê°€ ì–´ë””ì„œ ì–´ë–»ê²Œ ì‹¤í–‰ë˜ëŠ”ì§€ í™•ì¸ : systemd ì„œë¹„ìŠ¤ì¸ì§€, static podì¸ì§€ë¥¼ ë¨¼ì € í™•ì¸
  # systemd ì„œë¹„ìŠ¤ ì—¬ë¶€ í™•ì¸
    systemctl status etcd
  # static pod ì—¬ë¶€ í™•ì¸ (kubeadmì—ì„œ ìì£¼ ì”€)
    ls -l /etc/kubernetes/manifests/etcd.yaml

ğŸ’¡2ë‹¨ê³„. í™˜ê²½ë³€ìˆ˜ ë˜ëŠ” ì‹¤í–‰ ì˜µì…˜ì—ì„œ ì¸ì¦ì„œÂ·ì—”ë“œí¬ì¸íŠ¸ í™•ì¸ - ì—¬ê¸°ì„œ ETCD_CERT_FILE, ETCD_KEY_FILE, ETCD_TRUSTED_CA_FILE, ETCD_LISTEN_CLIENT_URLSë¥¼ í™•ì¸.
  #systemd í™˜ê²½
    systemctl cat etcd
    cat /etc/etcd.env
  #static pod í™˜ê²½
    grep -E -- '--cert-file|--key-file|--trusted-ca-file|--listen-client-urls' /etc/kubernetes/manifests/etcd.yaml

ğŸ’¡3ë‹¨ê³„. ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
  ETCDCTL_API=3 etcdctl \
  --endpoints=https://< ì£¼ETCD ìˆëŠ” IP>:2379 \
  --cacert=<ca ê²½ë¡œ> \
  --cert=<cert ê²½ë¡œ> \
  --key=<key ê²½ë¡œ> \
  endpoint status -w table



* kubespray *
(ìµœì‹  kubespray ê²½ë¡œ í™•ì¸í•œ ëª…ë ¹ì–´ : sudo cat /etc/etcd.env | grep -E 'ETCD_(NAME|DATA_DIR|ADVERTISE_CLIENT_URLS|LISTEN_CLIENT_URLS|TRUSTED_CA_FILE|CERT_FILE|KEY_FILE)=')


ETCDCTL_API=3 etcdctl snapshot save /home/<ì‚¬ìš©ì>/<ì„¤ì •í•œ ë””ë ‰í† ë¦¬ëª…>/db.snapshot \
  --endpoints=https://(etcd í´ëŸ¬ìŠ¤í„°ì˜ ip - ë³µì œí•  etcdê°€ ìˆëŠ” ë§ˆìŠ¤í„° ë…¸ë“œ ip):2379 \
  --cacert=/etc/kubernetes/ssl/etcd/ca.crt \
  --cert=/etc/kubernetes/ssl/apiserver-etcd-client.crt \
  --key=/etc/kubernetes/ssl/apiserver-etcd-client.key

KubesprayëŠ” etcdë„ Ansibleë¡œ ì„¤ì¹˜. ì¸ì¦ì€ í´ëŸ¬ìŠ¤í„° ë‚´ apiserverê°€ etcdì— ì ‘ì†í•  ë•Œ ì‚¬ìš©í•˜ëŠ” client ì¸ì¦ì„œ ì‚¬ìš©. /etc/kubernetes/ssl/apiserver-etcd-client.crtëŠ” apiserver â†’ etcd ì¸ì¦ì— ì‚¬ìš©
ì¦‰, etcdì˜ í´ë¼ì´ì–¸íŠ¸ë¡œì„œ ì¸ì¦í•˜ë¯€ë¡œ apiserver-etcd-client ì¸ì¦ì„œë¥¼ ì‚¬ìš©

* kubeadm *

ETCDCTL_API=3 etcdctl --endpoints=https://127.0.0.1:2379 \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/server.crt --key=/etc/kubernetes/pki/etcd/server.key \
  snapshot save /home/<ì‚¬ìš©ìëª…>/<ë‚´ê°€ ì§€ì •í•œ ë””ë ‰í† ë¦¬ëª…>/db.snapshot

ë°±ì—… ì‹œ etcd ì„œë²„ë¡œ ì¸ì¦ â†’ server.crt/server.key ì‚¬ìš©. etcd ì„œë²„ê°€ ë‚˜ ìì‹ ì´ë¯€ë¡œ server ì¸ì¦ì„œë¥¼ ì‚¬ìš©



-- etcd ë³µêµ¬ ëª…ë ¹ --

* kubeadm *

etcdutl --data-dir <ë³µêµ¬í•  ë””ë ‰í† ë¦¬ ë³´í†µì€ etcd ì„¤ì¹˜ë˜ì–´ ìˆëŠ” ê²½ë¡œ : /var/lib/etcd-new> snapshot restore /home/<ì‚¬ìš©ìëª…>/<ë‚´ê°€ ì§€ì •í•œ ë””ë ‰í† ë¦¬ëª…>/db.snapshot
1. ê¸°ì¡´ì˜ etcd ì§€ìš°ê¸° : mv /var/lib/etcd /var/lib/etcd-old
3. ìƒˆë¡œìš´ etcd ì˜®ê¸°ê¸° : mv /var/lib/etcd-new /var/lib/etcd

2. ê¸°ì¡´ì˜ etcd.yaml ì§€ìš°ê¸° : mv /etc/kubernetes/manifests/etcd.yaml /etc/kubernetes/manifests/etcd.yaml.bak
4. ìƒˆë¡œìš´ etcd.yaml ì˜®ê¸°ê¸° (etcd ì¬ê¸°ë™) : mv /etc/kubernetes/manifests/etcd.yaml.bak /etc/kubernetes/manifests/etcd.yaml

watch crictl ps ëª…ë ¹ìœ¼ë¡œ static pod ë“¤ ì¬ìƒì„± ë˜ëŠ”ì§€ í™•ì¸.
kubectl get no ë¡œ ì •ìƒì ìœ¼ë¡œ í†µì‹  ë˜ëŠ”ì§€ í™•ì¸


* kubespray *

1ë‹¨ê³„: ëª¨ë“  etcd ë…¸ë“œì—ì„œ etcd ì¤‘ì§€
mv /etc/kubernetes/manifests/etcd.yaml /etc/kubernetes/manifests/etcd.yaml.bak

2ë‹¨ê³„: etcd ë°ì´í„° ë°±ì—…
mv /var/lib/etcd /var/lib/etcd-old

3ë‹¨ê³„: etcd ìŠ¤ëƒ…ìƒ· ë³µì› (í•œ ë…¸ë“œì—ì„œë§Œ) - ê¸°ì¡´ì— etcd.yaml íŒŒì¼ì—ì„œ ì •ë³´ë¥¼ í™•ì¸(1ë‹¨ê³„ì „ ì‘ì—…í•˜ê¸°)
ETCDCTL_API=3 etcdctl snapshot restore /home/kei/backup/db.snapshot \
  --name=<etcd.yamlì— ì´ë¦„ê³¼ ê°™ê²Œ> \
  --initial-cluster=<etcd.yamlê³¼ ê°™ê²Œ> \
  --initial-advertise-peer-urls=<etcd.yamlê³¼ ê°™ê²Œ> \
  --initial-cluster-token=etcd-cluster-1 \(ìƒëµí•´ë„ ë¨)
  --data-dir=/var/lib/etcd
** initial-clusterëŠ” ë³µêµ¬ ì‹œì ì— ë©¤ë²„ 1ê°œë§Œ ìˆì–´ì•¼ í•˜ë¯€ë¡œ etcd-1ë§Œ ëª…ì‹œ **
ã…£ã„´

4ë‹¨ê³„: inventory.ini ìˆ˜ì • (ì„ì‹œë¡œ etcd ë©¤ë²„ë¥¼ 1ê°œë¡œ ì œí•œ)
[etcd]
master-1 ansible_host=10.0.0.1

5ë‹¨ê³„: Kubesprayë¡œ ë³µêµ¬í•œ etcdë¥¼ ê¸°ì¤€ìœ¼ë¡œ í´ëŸ¬ìŠ¤í„° ë³µì›
ansible-playbook -i inventory/dev/inventory.ini <ì ì ˆí•œ ê²½ë¡œ/cluster.yml> -b -v --tags=etcd -K

6ë‹¨ê³„: inventory.iniì— ë‚˜ë¨¸ì§€ etcd ë©¤ë²„ ì¶”ê°€
[etcd]
master-1 ansible_host=10.0.0.1
master-2 ansible_host=10.0.0.2
master-3 ansible_host=10.0.0.3

7ë‹¨ê³„: ë‚˜ë¨¸ì§€ ë©¤ë²„ ì¡°ì¸ (etcd member add + Kubesprayë¡œ êµ¬ì„±)
ansible-playbook -i inventory/dev/inventory.ini <ì ì ˆí•œ ê²½ë¡œ/cluster.yml> -b -v --tags=etcd -K

8ë‹¨ê³„: í´ëŸ¬ìŠ¤í„° ë³µêµ¬ í™•ì¸
ETCDCTL_API=3 etcdctl member list \
  --endpoints=https://127.0.0.1:2379 \
  --cacert=... --cert=... --key=...

kubectl get nodes
kubectl get pods -A


